<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C3C – Interactive 3D Customizer</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;background:#e9eaee;color:#111;font-family:sans-serif}
#app{display:flex;height:100vh}
#ui{width:340px;max-width:340px;min-width:300px;padding:10px;background:#f4f5f7;overflow:auto;border-right:1px solid #dde0e6}
#canvasWrap{flex:1;position:relative;background:#e9eaee}
#c{display:block;width:100%;height:100%}
.row{margin-bottom:10px;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
label{font-size:14px}
input,select,button{background:#fff;color:#111;border:1px solid #cfd6df;padding:6px;border-radius:4px}
button{cursor:pointer}
#decalGallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px}
#decalGallery button{background:#fff;border:1px solid #cfd6df;border-radius:6px;padding:0;overflow:hidden;height:72px}
#decalGallery img{width:100%;height:100%;object-fit:contain;background:#fff}
.note{font-size:12px;opacity:.75;color:#333}
#buildTag{position:fixed;left:8px;top:6px;opacity:.85;font:12px/1 monospace;z-index:10;color:#333}
#errorTag{position:fixed;right:8px;top:6px;background:#b00020;color:#fff;padding:6px 8px;border-radius:6px;display:none;max-width:70ch;font:12px/1.2 monospace;z-index:10}
.selectedDecal{outline:2px solid #4caf50}
</style>

<!-- Pin Three r159 + legacy example scripts (no modules, no dynamic imports) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/examples/js/loaders/DRACOLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/examples/js/geometries/DecalGeometry.js"></script>
</head>
<body>
<div id="buildTag">initializing…</div>
<div id="errorTag"></div>

<div id="app">
  <div id="ui">
    <div class="row">
      <label for="vehicleSelect">Vehicle:</label>
      <select id="vehicleSelect"></select>
    </div>
    <div class="row">
      <label for="bodyColor">Body Color:</label>
      <input type="color" id="bodyColor" value="#1c4cff">
      <button id="applyColorBtn">Apply</button>
    </div>
    <div class="row">
      <label>Decals (click to select):</label>
      <div id="decalGallery"></div>
    </div>
    <div class="row">
      <label for="decalUpload">Upload your decal:</label>
      <input type="file" id="decalUpload" accept="image/*">
    </div>
    <div class="note">Click a decal, then click on the vehicle to place it. Drag decals to move them.</div>
  </div>
  <div id="canvasWrap"><canvas id="c"></canvas></div>
</div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  vehicles: [
    { name:"Durango",  url:"https://static.wixstatic.com/3d/96cc34_c0072ed49aab4a86b58e8856adc9e80d.glb" },
    { name:"Explorer", url:"https://static.wixstatic.com/3d/96cc34_26fca487bc13404a965465fa0894bb31.glb" },  // updated
    { name:"Mercedes (Ambulance)", url:"https://static.wixstatic.com/3d/96cc34_9fce89e6202d462eb9efb22164250445.glb" }, // updated
    { name:"Tahoe",    url:"https://static.wixstatic.com/3d/96cc34_3402bc1505d84d25a03dfdd63dc98cb5.glb" }   // updated
  ],
  decals: [
    "https://static.wixstatic.com/media/96cc34_45d6c4ae8e19430bb0f853a313752d6e~mv2.png",
    "https://static.wixstatic.com/media/96cc34_3b6ee3d5d22046269faa3f0abfa5be4b~mv2.png",
    "https://static.wixstatic.com/media/96cc34_02a7f12787d94a338b71cbc076c131ef~mv2.png",
    "https://static.wixstatic.com/media/96cc34_d3aae6ee15ea45b99d31d20148e73144~mv2.png",
    "https://static.wixstatic.com/media/96cc34_738b9da24fef4290b6e3ae9996a8e722~mv2.png",
    "https://static.wixstatic.com/media/96cc34_cbb180b170324ffa8803f487f2c588e3~mv2.png",
    "https://static.wixstatic.com/media/96cc34_60097843bb9a4db39d54929f138ab552~mv2.png"
  ],
  bodyMaterialNameIncludes:["body","paint","carpaint","car_paint","vehicle_body","shell","panel","door","hood","fender","quarter","bumper"]
};

const buildTag = document.getElementById('buildTag');
const errorTag = document.getElementById('errorTag');
function showError(msg){ errorTag.style.display='block'; errorTag.textContent = msg; console.error(msg); }

/* ===== Globals ===== */
let scene,camera,renderer,controls,raycaster,mouse;
let currentVehicle=null,decalTextureURL=null;
let decals=[], draggingDecal=null, dragOffset=null;
let vehicleMaxSize=5;

/* ===== Start ===== */
window.onload = () => { try { init(); animate(); } catch(e){ showError('Init error: ' + e.message); } };

function init(){
  const canvas=document.getElementById("c");
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0xe9eaee);

  camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,2000);
  camera.position.set(0, 2, 8);

  renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth-340,window.innerHeight);
  if (renderer.outputColorSpace) renderer.outputColorSpace = THREE.SRGBColorSpace;

  const hemi=new THREE.HemisphereLight(0xffffff,0xcfd6df,0.9); scene.add(hemi);
  const dir=new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(5,10,7); scene.add(dir);

  if (THREE.OrbitControls) {
    controls=new THREE.OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true;
  }

  const ground=new THREE.Mesh(
    new THREE.PlaneGeometry(50,50),
    new THREE.MeshStandardMaterial({color:0xdfe3ea,roughness:1})
  );
  ground.rotation.x=-Math.PI/2; ground.position.y=0; scene.add(ground);

  raycaster=new THREE.Raycaster();
  mouse=new THREE.Vector2();

  setupUI();

  window.addEventListener("resize",onResize);
  renderer.domElement.addEventListener("pointerdown",onPointerDown);
  renderer.domElement.addEventListener("pointermove",onPointerMove);
  renderer.domElement.addEventListener("pointerup",()=>draggingDecal=null);

  buildTag.textContent = `Build r${THREE.REVISION} • vehicles: ${CONFIG.vehicles.length} • decals: ${CONFIG.decals.length}`;
}

function onResize(){
  const w=window.innerWidth-340,h=window.innerHeight;
  camera.aspect=w/h; camera.updateProjectionMatrix();
  renderer.setSize(w,h);
}

/* ===== Fit camera ===== */
function fitCameraToObject(obj, offset=1.6){
  const box = new THREE.Box3().setFromObject(obj);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  vehicleMaxSize = Math.max(size.x, size.y, size.z);

  const fitHeight = vehicleMaxSize / (2 * Math.tan(THREE.MathUtils.degToRad(camera.fov) / 2));
  const fitWidth  = fitHeight / camera.aspect;
  const distance  = offset * Math.max(fitHeight, fitWidth);

  const currentTarget = (controls && controls.target) ? controls.target.clone() : new THREE.Vector3();
  const dir = camera.position.clone().sub(currentTarget).normalize();

  camera.position.copy(center.clone().add(dir.multiplyScalar(distance)));
  if (controls && controls.target) {
    controls.target.copy(center);
    controls.minDistance = distance * 0.4;
    controls.maxDistance = distance * 5;
    controls.update();
  } else {
    camera.lookAt(center);
  }
  camera.updateProjectionMatrix();
}

/* ===== UI ===== */
function setupUI(){
  const vs=document.getElementById("vehicleSelect");
  vs.innerHTML="";
  CONFIG.vehicles.forEach(v=>{
    const opt=document.createElement("option");
    opt.value=v.url; opt.textContent=v.name; vs.appendChild(opt);
  });
  vs.addEventListener("change",()=>loadVehicle(vs.value));
  if(CONFIG.vehicles.length){
    loadVehicle(CONFIG.vehicles[0].url);
    vs.value=CONFIG.vehicles[0].url;
  }

  const gallery=document.getElementById("decalGallery");
  gallery.innerHTML="";
  let lastBtn=null;
  CONFIG.decals.forEach(url=>{
    const btn=document.createElement("button");
    const img=document.createElement("img");
    img.src=url; btn.appendChild(img);
    btn.addEventListener("click",()=>{
      decalTextureURL=url;
      if(lastBtn) lastBtn.classList.remove('selectedDecal');
      btn.classList.add('selectedDecal'); lastBtn=btn;
    });
    gallery.appendChild(btn);
  });

  document.getElementById("decalUpload").addEventListener("change",e=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      decalTextureURL=ev.target.result;
      document.querySelectorAll('#decalGallery .selectedDecal').forEach(b=>b.classList.remove('selectedDecal'));
    };
    reader.readAsDataURL(file);
  });

  document.getElementById("applyColorBtn").addEventListener("click",()=>{
    applyBodyColor(document.getElementById("bodyColor").value);
  });
}

/* ===== Load/position vehicle ===== */
function loadVehicle(url){
  // clear decals
  decals.forEach(d => { d.parent?.remove(d); d.geometry?.dispose(); if (d.material?.map) d.material.map.dispose(); d.material?.dispose(); });
  decals = [];

  if(currentVehicle) scene.remove(currentVehicle);
  currentVehicle=null;

  if (!THREE.GLTFLoader) { showError('GLTFLoader missing; cannot load models.'); return; }

  const loader=new THREE.GLTFLoader();

  if (THREE.DRACOLoader && loader.setDRACOLoader) {
    const dl = new THREE.DRACOLoader();
    dl.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
    loader.setDRACOLoader(dl);
  }

  loader.load(url,(gltf)=>{
    currentVehicle=gltf.scene;
    scene.add(currentVehicle);

    // normalize to consistent size
    const box0=new THREE.Box3().setFromObject(currentVehicle);
    const size0=new THREE.Vector3(); box0.getSize(size0);
    const center0=new THREE.Vector3(); box0.getCenter(center0);
    currentVehicle.position.sub(center0);

    const scale=4.5/Math.max(size0.x, size0.z || 1);
    currentVehicle.scale.setScalar(scale);

    // align lowest point to y=0 (wheels on ground)
    const box1=new THREE.Box3().setFromObject(currentVehicle);
    currentVehicle.position.y -= box1.min.y;

    fitCameraToObject(currentVehicle, 1.4);
  },undefined,err=>{
    showError("Could not load vehicle model. Check the URL.");
  });
}

/* ===== Body-only Paint (skip glass/tires/lights) ===== */
function applyBodyColor(hex){
  if(!currentVehicle)return;
  const hints=CONFIG.bodyMaterialNameIncludes;
  const hexColor=new THREE.Color(hex);

  currentVehicle.traverse(obj=>{
    if(!obj.isMesh || !obj.material) return;
    const mats = Array.isArray(obj.material)?obj.material:[obj.material];

    mats.forEach((m,i)=>{
      const name=((m.name||'')+' '+(obj.name||'')).toLowerCase();

      const looksLikeBody = hints.some(h=> name.includes(h));
      const isGlass = m.transparent || m.opacity < 0.98 || m.transmission > 0 || name.includes('glass')||name.includes('window')||name.includes('windshield');
      const isWheel = name.includes('tire')||name.includes('tyre')||name.includes('wheel')||name.includes('rim')||name.includes('hub');
      const isLight = name.includes('light')||name.includes('lamp')||name.includes('head')||name.includes('tail');

      if(isGlass || isWheel || isLight) return;

      // also color big exterior shells
      const bigMesh = (obj.geometry && obj.geometry.attributes && obj.geometry.attributes.position && obj.geometry.attributes.position.count > 5000);

      if(looksLikeBody || bigMesh){
        const clone = m.clone();
        clone.color = hexColor.clone();
        clone.map = null; // show pure paint
        clone.metalness = (m.metalness!==undefined? m.metalness : 0.1);
        clone.roughness = (m.roughness!==undefined? m.roughness : 0.45);
        clone.transparent = false;
        clone.transmission = 0;
        clone.needsUpdate = true;
        if(Array.isArray(obj.material)) obj.material[i]=clone; else obj.material=clone;
      }
    });
  });
}

/* ===== Decals: click to place, drag to move ===== */
function onPointerDown(event){
  if(!renderer || !renderer.domElement) return;
  const el = renderer.domElement;
  const rect = el.getBoundingClientRect();
  mouse.x=((event.clientX-rect.left)/rect.width)*2-1;
  mouse.y=-((event.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,camera);

  // drag existing decal?
  const decalHits=raycaster.intersectObjects(decals,true);
  if(decalHits.length){
    draggingDecal=decalHits[0].object;
    dragOffset=draggingDecal.position.clone().sub(decalHits[0].point);
    return;
  }

  // place new decal
  if(!decalTextureURL||!currentVehicle||!THREE.DecalGeometry) return;

  const hits=raycaster.intersectObject(currentVehicle,true);
  if(hits.length){
    const hit=hits[0];
    addDecalOnHit(hit, decalTextureURL);
  }
}

function onPointerMove(event){
  if(!draggingDecal)return;
  const el = renderer.domElement;
  const rect = el.getBoundingClientRect();
  mouse.x=((event.clientX-rect.left)/rect.width)*2-1;
  mouse.y=-((event.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObject(currentVehicle,true);
  if(hits.length){
    const hit=hits[0];
    draggingDecal.position.copy(hit.point.add(dragOffset||new THREE.Vector3()));
  }
}

function addDecalOnHit(hit, texURL){
  const targetMesh = hit.object;
  const position   = hit.point.clone();

  // world normal
  const normal = hit.face.normal.clone();
  normal.transformDirection(new THREE.Matrix3().getNormalMatrix(targetMesh.matrixWorld));
  const quat = new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0,0,1), normal.clone().normalize());
  const orientation = new THREE.Euler().setFromQuaternion(quat);

  const s = Math.max(0.2, vehicleMaxSize * 0.12);
  const size = new THREE.Vector3(s, s, 0.05);

  const loader = new THREE.TextureLoader();
  loader.setCrossOrigin('anonymous');
  const tex = loader.load(texURL);
  if (renderer.outputColorSpace) tex.colorSpace = THREE.SRGBColorSpace;
  tex.anisotropy = 8;

  const mat = new THREE.MeshStandardMaterial({
    map: tex,
    color: 0xffffff,
    transparent: true,
    opacity: 1,
    depthTest: true,
    depthWrite: false,
    polygonOffset: true,
    polygonOffsetFactor: -0.1,
    side: THREE.DoubleSide
  });

  const geo  = new THREE.DecalGeometry(targetMesh, position, orientation, size);
  if (!geo || !geo.attributes || !geo.attributes.position || geo.attributes.position.count === 0) {
    console.warn('DecalGeometry produced empty geometry (skipping).');
    return;
  }
  const mesh = new THREE.Mesh(geo, mat);
  scene.add(mesh);
  decals.push(mesh);
}

/* ===== Loop ===== */
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
}
</script>
</body>
</html>
